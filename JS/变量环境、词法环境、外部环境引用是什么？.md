![[Untitled diagram-2024-09-15-023858.png]]


---

## **1. 词法环境（Lexical Environment）**

### **定义**

词法环境是一个规范类型（specification type），用于在代码执行过程中存储标识符（变量、函数）的**标识符-变量映射**。它由两个主要部分组成：

- **环境记录（Environment Record）**：一个存储标识符和其绑定值的对象。
- **外部环境引用（Outer Environment Reference）**：指向外部词法环境的引用，用于实现作用域链。

### **特点**

- **静态作用域**：词法环境在代码编写时就确定了，它基于代码的书写位置，而不是运行时的调用栈。
- **作用域链的基础**：多个词法环境通过外部环境引用连接起来，形成作用域链。

### **示例**

在您的代码中，每当一个函数被定义时，都会创建一个新的词法环境。例如：

```javascript
function outer() {
  // outer 的词法环境创建
}
```

---

## **2. 变量环境（Variable Environment）**

### **定义**

变量环境也是一种词法环境，但在 ECMAScript 规范中，它专门用于处理 `var` 声明的变量和函数声明。它与词法环境的结构相同，也包含环境记录和外部环境引用。

### **区别**

- **变量环境**：处理 `var` 声明的变量和函数声明。
- **词法环境**：处理 `let`、`const` 声明的变量，以及捕获的变量（闭包）。

### **在执行上下文中的作用**

每个执行上下文都有：

- 一个**变量环境**：存储 `var` 声明的变量和函数声明。
- 一个**词法环境**：存储 `let`、`const` 声明的变量。

### **示例**

在 `outer` 函数中：

```javascript
function outer() {
  var b = 2; // 存储在变量环境中
}
```

变量 `b` 是通过 `var` 声明的，因此被存储在变量环境中。

---

## **3. 外部环境引用（Outer Environment Reference）**

### **定义**

外部环境引用是词法环境中的一个属性，指向其外部（父级）词法环境。这使得 JavaScript 能够在当前环境中找不到某个标识符时，沿着作用域链向上查找。

### **作用**

- **实现作用域链**：通过外部环境引用，多个词法环境链接在一起，形成作用域链。
- **变量解析**：当访问一个变量时，JavaScript 引擎会在当前环境的环境记录中查找，找不到则通过外部环境引用到上一级环境，依次类推，直到全局环境。

### **示例**

在 `inner` 函数中：

```javascript
function inner() {
  console.log(b); // b 不在当前环境，沿着外部环境引用查找
}
```

`inner` 函数的外部环境引用指向 `outer` 函数的词法环境，所以能够访问到变量 `b`。

---

## **在您的代码中的体现**

### **代码回顾**

```javascript
function outer() {
  var b = 2; // 存储在 outer 的变量环境中

  return function inner() {
    console.log(b); // 通过作用域链访问 b
  };
}

var innerFunc = outer(); // outer 执行完毕
innerFunc(); // 输出 2
```

### **执行过程**

1. **调用 `outer()`，创建 `outer` 执行上下文：**

   - **变量环境：**

     - 存储 `var b = 2;`。

   - **词法环境：**

     - 存储 `inner` 函数的引用。

   - **外部环境引用：**

     - 指向全局执行上下文的词法环境。

2. **定义并返回 `inner` 函数：**

   - `inner` 函数在定义时，捕获了对其外部环境（`outer` 的词法环境）的引用，这就是闭包的形成。

3. **调用 `innerFunc()`，创建 `inner` 执行上下文：**

   - **变量环境：**

     - 没有 `var` 声明的变量。

   - **词法环境：**

     - 没有 `let`、`const` 声明的变量。

   - **外部环境引用：**

     - 指向 `outer` 函数的词法环境。

4. **执行 `console.log(b);`：**

   - 在 `inner` 的环境记录中查找 `b`，未找到。
   - 通过外部环境引用到 `outer` 的词法环境中查找，找到 `b = 2`。
   - 输出 `2`。

---

## **总结**

- **词法环境（Lexical Environment）**：

  - 存储当前作用域的标识符和绑定。
  - 包含环境记录和外部环境引用。
  - 用于 `let`、`const` 声明的变量，以及捕获的变量（闭包）。

- **变量环境（Variable Environment）**：

  - 专门用于存储 `var` 声明的变量和函数声明。
  - 与词法环境结构相同，但用途不同。

- **外部环境引用（Outer Environment Reference）**：

  - 指向外部词法环境。
  - 实现了作用域链，使得嵌套的函数可以访问其外部作用域的变量。

---

## **深入理解**

- **执行上下文（Execution Context）**：

  - 每次函数调用都会创建一个新的执行上下文。
  - 包含变量环境、词法环境和其他信息。

- **作用域链（Scope Chain）**：

  - 由当前词法环境和所有外部环境引用组成的链式结构。
  - 用于在标识符解析时，逐级查找变量。

- **闭包（Closure）**：

  - 当一个函数能够记住并访问其定义时的词法环境，即使在其外部执行时，形成了闭包。
  - 在您的代码中，`inner` 函数就是一个闭包。

---

**希望以上解释能帮助您理解这些概念。如有任何疑问，欢迎继续提问！**